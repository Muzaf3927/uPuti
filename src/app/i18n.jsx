import React, { createContext, useContext, useMemo, useState, useEffect } from "react";
import { safeLocalStorage } from "@/lib/localStorage";

const I18nContext = createContext({ lang: "ru", t: (k) => k, setLang: () => {} });

const dict = {
  uz: {
    nav: {
      requests: "So'rovlar",
      booking: "Bronlar",
      history: "Tarix",
      trips: "Safarlar",
      chats: "Chatlar",
    },
    chats: {
      selectChat: "Chatni tanlang",
      placeholder: "Xabar yozing...",
      send: "Yuborish",
    },
    booking: {
      myBookings: "Mening bronlarim",
      toMe: "Yo'lovchilar bronlari",
      loading: "Yuklanmoqda...",
      none: "Sizda bonlar yo'q.",
      myTripsNone: "Sizda safarlar yo'q.",
      writeDriver: "Haydovchiga yozish",
      writePassenger: "Yo'lovchiga yozish",
      write: "Yozish",
      call: "Qo'ng'iroq qilish",
    },
    history: {
      driverTab: "Men xaydovchi",
      passengerTab: "Men yo'lovchi",
      empty: "Safarlar tarixi bo‘sh",
      totalEarn: "Umumiy daromad",
      completed: "Yakunlangan",
      rate: "Baholash",
      rateDriver: "Haydovchini baholash",
      save: "Saqlash",
      cancel: "Bekor qilish",
      ratingTitle: "Foydalanuvchini baholash",
      ratingComment: "Izoh (ixtiyoriy)",
      rated: "baxolangan",
      yourTrip: "Sizning safaringiz",
      earned: "Foyda",
      ratingSubmitted: "Baxo yuborildi",
      skip: "O'tkazib yuborish",
      next: "Keyingi",
      finish: "Yakunlash",
    },
    tripsCard: {
      book: "Bron qilish",
      offer: "Narx taklif qilish",
      cancel: "Bekor qilish",
      seats: "o'rindiq",
      priceSuffix: "sum",
      commentPlaceholder: "Shuncha so'm taklif qila olaman",
      bookingTitle: "Nechta o'rin?",
      offerTitle: "Narx taklif qilish",
      seatsLabel: "O'rindiqlar soni",
      seatsPlaceholder: "1-4 o'rin",
      priceLabel: "Taklif narxi (so'm)",
      commentLabel: "Izoh",
      submitBooking: "Yuborish",
      submitOffer: "Yuborish",
      cancelButton: "Bekor qilish"
    },
    profile: {
      back: "Orqaga qaytish",
      edit: "Tahrirlash",
      balance: "Balans:",
      rating: "Reyting:",
      hello: "Salom",
    },
    profilePage: {
      nameLabel: "Ism",
      namePlaceholder: "Ismingizni kiriting",
      save: "Saqlash",
      saving: "Saqlanmoqda...",
      cancel: "Bekor qilish",
      verified: "Tasdiqlangan",
      deleteAccount: "Akkauntni o'chirish",
      deleting: "O'chirilmoqda...",
      confirmTitle: "Akkauntni o'chirishni tasdiqlash",
      confirmDescription: "Haqiqatan ham akkauntingizni o'chirmoqchimisiz?",
      confirm: "Ha, o'chirish",
      close: "Yopish",
      errorLoading: "Profilni yuklashda xatolik",
      none: "—"
    },
    trips: {
      all: "Barcha safarlar",
      mine: "Mening safarlarim",
      create: "Safar yaratish",
      search: "Safar qidirish",
      empty: "Sizda safarlar yo'q.",
      commentPlaceholder: "Samarqand orqali ketaman",
      form: {
        from: "Qayerdan",
        to: "Qayerga",
        date: "Sana",
        time: "Vaqt",
        cost: "Yo'lkira",
        carModel: "Mashina modeli",
        carColor: "Mashina rangi",
        carNumber: "Mashina raqami",
        carSeats: "O'rindiqlar soni",
        note: "Izoh",
        cancel: "Bekor qilish",
        submit: "Yaratish",
        submitting: "Yaratilmoqda...",
        fromPlaceholder: "Toshkent",
        toPlaceholder: "Buxoro",
        costPlaceholder: "50000",
        carModelPlaceholder: "Nexia",
        carColorPlaceholder: "Oq",
        carNumberPlaceholder: "01A123BC",
        carSeatsPlaceholder: "4",
        validationError: "Iltimos, barcha majburiy maydonlarni to'ldiring",
        successMessage: "Safar yaratildi.",
        errorMessage: "Safar yaratishda xatolik yuz berdi."
      },
      searchForm: {
        from: "Qayerdan",
        to: "Qayerga",
        date: "Sana",
        fromPlaceholder: "Qaysi shahardan",
        toPlaceholder: "Qaysi shaharga",
        datePlaceholder: "06.09.2025",
        search: "Qidirish",
        cancel: "Bekor qilish",
        clear: "Qidiruvni tozalash"
      },
      confirmation: {
        title: "Tasdiqlash",
        message: "Sizning so'rovingiz haydovchi tomonidan qabul qilinganidan so'ng, siz haydovchi bilan  yoki haydovchi siz bilan bog'lanishi mumkin",
        continue: "Davom etish",
        cancel: "Bekor qilish"
      }
    },
    auth: {
      slogan: "Birgalikda yo'l — hamyonbop va ishonchli",
      reliableCompanions: "Ishonchli sayohat hamrohlari",
      convenientRoutes: "Qulay yo'nalishlar",
      loginTitle: "Tizimga kirish",
      loginSubtitle: "Profilingizga kiring",
      loginBtn: "Kirish",
      loginLoading: "Kirilmoqda...",
      forgot: "Parol esdan chiqdimi?",
      needAccount: "Hisobingiz yo'qmi?",
      register: "Ro'yhatdan o'ting",
      phoneLabel: "Telefon raqami",
      passwordLabel: "Parol",
      signupTitle: "Ro'yhatdan o'tish",
      signupSubtitle: "Profil yaratish",
      nameLabel: "Ism",
      phonePlaceholder: "90 123 45 67",
      signupBtn: "Ro'yhatdan o'tish",
      signupProgress: "Ro'yhatdan o'tilmoqda...",
      haveAccount: "Profilingiz bormi?",
      goLogin: "Profilga kirish",
      passwordMinLength: "Parol kamida 6 ta belgi bo'lishi kerak!",
      passwordsNotMatch: "Parollar mos emas!",
      fillAllFields: "Iltimos hammasini to'ldiring.",
      verifyTitle: "SMS dan kelgan kodni kiriting",
      code: "Kod",
      send: "Yuborish",
      forgotPassword: {
        title: "Parolni yangilash",
        subtitle: "Telefon raqamingizni kiriting",
        phoneLabel: "Telefon raqami",
        phonePlaceholder: "90 123 45 67",
        button: "Parolni yangilash",
        loading: "Parol yangilanmoqda...",
        haveAccount: "Profilingiz bormi?",
        goLogin: "Tizimga kiring",
        resetTitle: "SMS dan kelgan kodni kiriting",
        passwordLabel: "Parol",
        confirmPasswordLabel: "Parolni tekshirish",
        passwordPlaceholder: "Parol",
        confirmPasswordPlaceholder: "Parolni tekshirish",
        submitButton: "Yuborish",
        successMessage: "Parol muvaffaqiyatli yangilandi!",
      },
    },
    myTripsCard: {
      requests: "So'rovlar",
      bookings: "Bronlar",
      complete: "Yakunlash",
      edit: "Tahrirlash",
      delete: "O'chirish",
      loading: "Yuklanmoqda...",
      noRequests: "So'rovlar yo'q.",
      noBookings: "Bronlar yo'q.",
      accept: "Qabul qilish",
      decline: "Bekor qilish",
      acceptedToast: "Tasdiqlandi.",
      declinedToast: "Bekor qilindi.",
      completeToast: "Safar yakunlandi.",
      completeError: "Yakunlashda xatolik.",
      call: "Qo'ng'iroq",
      message: "Xabar",
      callPassenger: "Qo'ng'iroq",
      writePassenger: "Yozish",
    },
    requests: {
      mineTab: "Junatilqan so'rovlar",
      toMeTab: "Qabul qilingan so'rovlar",
      loading: "Yuklanmoqda...",
      emptyMine: "So'rovlaringiz yo'q.",
      emptyToMe: "Sizning kelgan so'rovlar yo'q.",
      pending: "Kutilmoqda",
      seats: "ta o'rin",
      price: "Narx",
      offer: "Taklif",
      accept: "Qabul qilish",
      decline: "Bekor qilish",
      acceptedToast: "Tasdiqlandi.",
      declinedToast: "Bekor qilindi.",
      acceptError: "Tasdiqlashda xatolik.",
      declineError: "Bekor qilishda xatolik.",
    },
    profilePanel: {
      support: "Texnik yordam",
      name: "Ism",
      phone: "Telefon",
      rating: "Reyting",
      balance: "Balans",
      logout: "Tizimdan chiqish",
      myProfile: "Mening profilim",
    },
    support: {
      title: "Savollar va takliflar uchun",
      description: "Telegram orqali yozing",
      button: "Yozish",
      close: "Yopish",
    },
  },
  ru: {
    nav: {
      requests: "Заявки",
      booking: "Брони",
      history: "История",
      trips: "Поездки",
      chats: "Чаты",
    },
    chats: {
      selectChat: "Выберите чат",
      placeholder: "Напишите сообщение...",
      send: "Отправить",
    },
    booking: {
      myBookings: "Мои брони",
      toMe: "Брони пассажиров",
      loading: "Загрузка...",
      none: "Пока нет броней.",
      myTripsNone: "Пока нет ваших поездок.",
      writeDriver: "Написать водителю",
      writePassenger: "Написать пассажиру",
      write: "Написать",
      call: "Позвонить",
    },
    history: {
      driverTab: "Как водитель",
      passengerTab: "Как пассажир",
      empty: "История поездок пуста",
      totalEarn: "Общий заработок",
      completed: "Завершено",
      rate: "Оценить",
      rateDriver: "Оценить водителя",
      save: "Сохранить",
      cancel: "Отмена",
      ratingTitle: "Оценка пользователю",
      ratingComment: "Комментарий (необязательно)",
      rated: "оценено",
      yourTrip: "Ваша поездка",
      earned: "Заработано",
      ratingSubmitted: "Оценка отправлена",
      skip: "Пропустить",
      next: "Далее",
      finish: "Завершить",
    },
    tripsCard: {
      book: "Забронировать",
      offer: "Предложить цену",
      cancel: "Отменить",
      seats: "мест",
      priceSuffix: "сум",
      commentPlaceholder: "Могу предложить столько сумм",
      bookingTitle: "Сколько мест хотите забронировать?",
      offerTitle: "Предложить цену",
      seatsLabel: "Количество мест",
      seatsPlaceholder: "1-4 места",
      priceLabel: "Предложенная цена (сум)",
      commentLabel: "Комментарий",
      submitBooking: "Отправить",
      submitOffer: "Отправить",
      cancelButton: "Отмена"
    },
    profile: {
      back: "Назад",
      edit: "Редактировать",
      balance: "Баланс:",
      rating: "Рейтинг:",
      hello: "Привет",
    },
    profilePage: {
      nameLabel: "Имя",
      namePlaceholder: "Введите имя",
      save: "Сохранить",
      saving: "Сохранение...",
      cancel: "Отмена",
      verified: "Подтвержден",
      deleteAccount: "Удалить аккаунт",
      deleting: "Удаление...",
      confirmTitle: "Подтверждение удаления аккаунта",
      confirmDescription: "Вы уверены, что хотите удалить свой аккаунт?",
      confirm: "Да, удалить",
      close: "Закрыть",
      errorLoading: "Ошибка при загрузке профиля",
      none: "—"
    },
    trips: {
      all: "Все поездки",
      mine: "Мои поездки",
      create: "Создать поездку",
      search: "Поиск поездки",
      empty: "Пока у вас нет поездок.",
      commentPlaceholder: "Поеду через Самарканд",
      form: {
        from: "Откуда",
        to: "Куда",
        date: "Дата",
        time: "Время",
        cost: "Стоимость",
        carModel: "Модель машины",
        carColor: "Цвет машины",
        carNumber: "Номер машины",
        carSeats: "Количество мест",
        note: "Примечание",
        cancel: "Отмена",
        submit: "Создать",
        submitting: "Создается...",
        fromPlaceholder: "Ташкент",
        toPlaceholder: "Бухара",
        costPlaceholder: "50000",
        carModelPlaceholder: "Nexia",
        carColorPlaceholder: "Белый",
        carNumberPlaceholder: "01А123БЦ",
        carSeatsPlaceholder: "4",
        validationError: "Пожалуйста, заполните все обязательные поля",
        successMessage: "Поездка создана.",
        errorMessage: "Ошибка при создании поездки."
      },
      searchForm: {
        from: "Откуда",
        to: "Куда",
        date: "Дата",
        fromPlaceholder: "Из какого города",
        toPlaceholder: "В какой город",
        datePlaceholder: "06.09.2025",
        search: "Поиск",
        cancel: "Отмена",
        clear: "Очистить поиск"
      },
      confirmation: {
        title: "Подтверждение",
        message: "После того как водитель примет вашу заявку, сможете друг с другом созвониться",
        continue: "Продолжить",
        cancel: "Отмена"
      }
    },
    auth: {
      slogan: "В путь вместе — доступно и надёжно",
      reliableCompanions: "Надёжные спутники в дороге",
      convenientRoutes: "Удобные маршруты",
      loginTitle: "Вход",
      loginSubtitle: "Войдите в аккаунт",
      loginBtn: "Войти",
      loginLoading: "Входим...",
      forgot: "Забыли пароль?",
      needAccount: "Нет аккаунта?",
      register: "Зарегистрируйтесь",
      phoneLabel: "Номер телефона",
      passwordLabel: "Пароль",
      signupTitle: "Регистрация",
      signupSubtitle: "Создайте аккаунт",
      nameLabel: "Имя",
      phonePlaceholder: "90 123 45 67",
      signupBtn: "Зарегистрироваться",
      signupProgress: "Регистрация...",
      haveAccount: "Уже есть аккаунт?",
      goLogin: "Войдите",
      passwordMinLength: "Пароль должен содержать минимум 6 символов!",
      passwordsNotMatch: "Пароли не совпадают!",
      fillAllFields: "Пожалуйста, заполните все поля.",
      verifyTitle: "Введите код из SMS",
      code: "Код",
      send: "Отправить",
      forgotPassword: {
        title: "Сброс пароля",
        subtitle: "Введите номер телефона",
        phoneLabel: "Номер телефона",
        phonePlaceholder: "90 123 45 67",
        button: "Сбросить пароль",
        loading: "Сброс пароля...",
        haveAccount: "Уже есть аккаунт?",
        goLogin: "Войти",
        resetTitle: "Введите код из SMS",
        passwordLabel: "Пароль",
        confirmPasswordLabel: "Подтвердите пароль",
        passwordPlaceholder: "Пароль",
        confirmPasswordPlaceholder: "Подтвердите пароль",
        submitButton: "Отправить",
        successMessage: "Пароль успешно обновлен!",
      },
    },
    myTripsCard: {
      requests: "Заявки",
      bookings: "Брони",
      complete: "Завершить",
      edit: "Редактировать",
      delete: "Удалить",
      loading: "Загрузка...",
      noRequests: "Заявок пока нет.",
      noBookings: "Броней пока нет.",
      accept: "Принять",
      decline: "Отклонить",
      acceptedToast: "Подтверждено.",
      declinedToast: "Отклонено.",
      completeToast: "Поездка завершена.",
      completeError: "Ошибка при завершении.",
      call: "Позвонить",
      message: "Сообщение",
      callPassenger: "Позвонить",
      writePassenger: "Написать",
    },
    requests: {
      mineTab: "Мои заявки",
      toMeTab: "Заявки ко мне",
      loading: "Загрузка...",
      emptyMine: "Пока нет отправленных заявок.",
      emptyToMe: "Пока нет заявок на ваши поездки.",
      pending: "В ожидании",
      seats: "мест",
      price: "Цена",
      offer: "Предложение",
      accept: "Принять",
      decline: "Отклонить",
      acceptedToast: "Подтверждено.",
      declinedToast: "Отклонено.",
      acceptError: "Ошибка при подтверждении.",
      declineError: "Ошибка при отклонении.",
    },
    profilePanel: {
      support: "Техподдержка",
      name: "Имя",
      phone: "Телефон",
      rating: "Рейтинг",
      balance: "Баланс",
      logout: "Выйти",
      myProfile: "Мой профиль",
    },
    support: {
      title: "Вопросы и предложения",
      description: "Свяжитесь через Telegram",
      button: "Написать",
      close: "Закрыть",
    },
  },
};

export function I18nProvider({ children }) {
  const [lang, setLang] = useState("ru");
  const [isReady, setIsReady] = useState(false);
  
  useEffect(() => {
    const saved = safeLocalStorage.getItem("lang");
    if (saved === "ru" || saved === "uz") {
      setLang(saved);
    } else {
      // По умолчанию первый визит — русский
      setLang("ru");
      safeLocalStorage.setItem("lang", "ru");
    }
    setIsReady(true);
  }, []);
  const t = useMemo(() => {
    const d = dict[lang] || dict.uz;
    return (key) => {
      const result = key.split(".").reduce((acc, k) => (acc && acc[k] !== undefined ? acc[k] : undefined), d);
      return result !== undefined ? result : key;
    };
  }, [lang]);
  const value = useMemo(
    () => ({
      lang,
      isReady,
      setLang: (l) => {
        safeLocalStorage.setItem("lang", l);
        setLang(l);
      },
      t,
    }),
    [lang, isReady, t]
  );
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}


